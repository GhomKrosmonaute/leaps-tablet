!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";!function(e){var t=e.URLSearchParams?e.URLSearchParams:null,n=t&&"a=1"===new t({a:1}).toString(),i="__URLSearchParams__",o=l.prototype,r=!(!e.Symbol||!e.Symbol.iterator);if(!t||!n){o.append=function(e,t){h(this[i],e,t)},o.delete=function(e){delete this[i][e]},o.get=function(e){var t=this[i];return e in t?t[e][0]:null},o.getAll=function(e){var t=this[i];return e in t?t[e].slice(0):[]},o.has=function(e){return e in this[i]},o.set=function(e,t){this[i][e]=[""+t]},o.toString=function(){var e,t,n,o,r=this[i],a=[];for(t in r)for(n=s(t),e=0,o=r[t];e<o.length;e++)a.push(n+"="+s(o[e]));return a.join("&")},e.URLSearchParams=t&&!n&&e.Proxy?new Proxy(t,{construct:function(e,t){return new e(new l(t[0]).toString())}}):l;var a=e.URLSearchParams.prototype;a.polyfill=!0,a.forEach=a.forEach||function(e,t){var n=u(this.toString());Object.getOwnPropertyNames(n).forEach(function(i){n[i].forEach(function(n){e.call(t,n,i,this)},this)},this)},a.sort=a.sort||function(){var e,t,n,i=u(this.toString()),o=[];for(e in i)o.push(e);for(o.sort(),t=0;t<o.length;t++)this.delete(o[t]);for(t=0;t<o.length;t++){var r=o[t],a=i[r];for(n=0;n<a.length;n++)this.append(r,a[n])}},a.keys=a.keys||function(){var e=[];return this.forEach(function(t,n){e.push([n])}),c(e)},a.values=a.values||function(){var e=[];return this.forEach(function(t){e.push([t])}),c(e)},a.entries=a.entries||function(){var e=[];return this.forEach(function(t,n){e.push([n,t])}),c(e)},r&&(a[e.Symbol.iterator]=a[e.Symbol.iterator]||a.entries)}function l(e){((e=e||"")instanceof URLSearchParams||e instanceof l)&&(e=e.toString()),this[i]=u(e)}function s(e){var t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'\(\)~]|%20|%00/g,function(e){return t[e]})}function d(e){return decodeURIComponent(e.replace(/\+/g," "))}function c(t){var n={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};return r&&(n[e.Symbol.iterator]=function(){return n}),n}function u(e){var t={};if("object"==typeof e)for(var n in e){if(e.hasOwnProperty(n))h(t,n,"string"==typeof e[n]?e[n]:JSON.stringify(e[n]))}else{0===e.indexOf("?")&&(e=e.slice(1));for(var i=e.split("&"),o=0;o<i.length;o++){var r=i[o],a=r.indexOf("=");-1<a?h(t,d(r.slice(0,a)),d(r.slice(a+1))):r&&h(t,d(r),"")}}return t}function h(e,t,n){t in e?e[t].push(""+n):e[t]=[""+n]}}("undefined"!=typeof global?global:"undefined"!=typeof window?window:void 0);var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),n=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},i=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};function o(){for(var e=new PIXI.Point,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=!0,r=!1,a=void 0;try{for(var l,s=n[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var d=l.value;e.x+=d.x,e.y+=d.y}}catch(e){r=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(r)throw a}}return e}function r(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=new PIXI.Point(t[0].x,t[0].y),o=1;o<t.length;o++)i.x-=t[o].x,i.y-=t[o].y;return i}function a(e,t){return new PIXI.Point(e.x/t,e.y/t)}function l(){for(var e=new PIXI.Point(1/0,1/0),t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=!0,r=!1,a=void 0;try{for(var l,s=n[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var d=l.value;e.x=Math.min(d.x,e.x),e.y=Math.min(d.y,e.y)}}catch(e){r=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(r)throw a}}return e}function s(){for(var e=new PIXI.Point(-1/0,-1/0),t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];var o=!0,r=!1,a=void 0;try{for(var l,s=n[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var d=l.value;e.x=Math.max(d.x,e.x),e.y=Math.max(d.y,e.y)}}catch(e){r=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(r)throw a}}return e}function d(){for(var e=new PIXI.Point,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=!0,l=!1,s=void 0;try{for(var d,c=n[Symbol.iterator]();!(r=(d=c.next()).done);r=!0){e=o(e,d.value)}}catch(e){l=!0,s=e}finally{try{!r&&c.return&&c.return()}finally{if(l)throw s}}return a(e,n.length)}function c(e,t){var n=!0,i=!1,o=void 0;try{for(var r,a=e[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){var l=r.value;if(_.isEqual(l,t))return!0}}catch(e){i=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}return!1}function u(e,t){var n=[],i=!0,o=!1,r=void 0;try{for(var a,l=e[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){var s=a.value;_.isEqual(s,t)||n.push(s)}}catch(e){o=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(o)throw r}}return n}function h(e,t,n){return e+((((16711680&t)>>16)-((16711680&e)>>16))*n<<16)+((((65280&t)>>8)-((65280&e)>>8))*n<<8)+((255&t)-(255&e))}function y(e){var t,n,i,o=new PIXI.Point(window.innerWidth,window.innerHeight),r=(t=Math.min(o.x/e.renderer.width,o.y/e.renderer.height),n=2,i=Math.pow(10,n),(Math.floor(t*i)/i).toFixed(n)),a=new PIXI.Point(r*e.renderer.width,r*e.renderer.height),l=new PIXI.Point(o.x-a.x,o.y-a.y);console.log("setting scale to",r);for(var s="scale("+r+") translate("+(l.x/2).toFixed(2)+"px, "+(l.y/2).toFixed(2)+"px)",d=(document.getElementById("game-container"),["transform","webkitTransform","msTransform"]),c=0;c<d.length;c++){var u=d[c];document.getElementById("game-container").style[u]=s}}function g(e,t){var n=e.children.map(function(e){return e.position}),i=r(t,d(l.apply(null,n),s.apply(null,n)));e.position=i}var p=function(o){function r(){return e(this,r),i(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return n(r,o),t(r,[{key:"setup",value:function(){}},{key:"update",value:function(e,t){}},{key:"teardown",value:function(){}},{key:"requestedTransition",value:function(e){return null}}]),r}(PIXI.utils.EventEmitter),f=(function(o){function r(t,n){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"start",a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"end";e(this,r);var l=i(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return l.states=t,l.transitions=n,l.startingState=o,l.endingState=a,l}n(r,p),t(r,[{key:"changeState",value:function(e,t){this.state&&this.state.teardown(),this.stateName=t,t in this.states?(this.state=this.states[t],this.state.setup()):(console.warn("Cannot find state",t),this.state=null),this.sceneStartedAt=e}},{key:"setup",value:function(){this.changeState(0,this.startingState)}},{key:"update",value:function(e,t){if(this.state){var n=e-this.sceneStartedAt;this.state.update(n,t);var i=this.state.requestedTransition(n);if(null!=i){var o=this.transitions[this.stateName][i];null!=o&&this.changeState(e,o)}}}},{key:"teardown",value:function(){this.state&&this.state.teardown()}},{key:"requestedTransition",value:function(e){return this.stateName==this.endingState?"next":null}}])}(),function(o){function r(){e(this,r);var t=i(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t.entities=arguments,t}n(r,p),t(r,[{key:"setup",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this.entities[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){i.value.setup()}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"update",value:function(e,t){var n=!0,i=!1,o=void 0;try{for(var r,a=this.entities[Symbol.iterator]();!(n=(r=a.next()).done);n=!0){r.value.update(e,t)}}catch(e){i=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(i)throw o}}}},{key:"teardown",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this.entities[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){i.value.teardown()}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"requestedTransition",value:function(e){return this.entities[0].requestedTransition(e)}}])}(),50),m=8513280;function v(e){return t=e,n=f,new PIXI.Point(t.x*n,t.y*n);var t,n}function k(e){return t=a(e,f),new PIXI.Point(Math.round(t.x),Math.round(t.y));var t}function I(e,t){e.beginFill(t),e.lineStyle(4,0,1),e.drawRect(-f/2,-f/2,f,f),e.endFill()}function b(e){var t=new PIXI.Graphics;return I(t,m),t.position=v(e),t}function w(e){return e.map(function(e){return[e.x,e.y]})}function B(e){return[e.x,e.y]}function E(e,t){return Math.min(2*(1/88*e*(72e4/t)-.5),1)}function P(){var e;document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullScreenElement?(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen(),S(!0)):((e=document.getElementById("game-parent")).requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),S(!1))}function S(e){e?(document.getElementById("fullscreen-button-small").style.display="none",document.getElementById("fullscreen-button-full").style.display="block"):(document.getElementById("fullscreen-button-small").style.display="block",document.getElementById("fullscreen-button-full").style.display="none")}function x(e){W&&W.teardown(),W=new A[H=e],V=Date.now(),W.setup(),W.update(0),j.postEvent({type:T[e]})}function C(e){var t=Date.now()-V;W.update(t,e);var n,i,o,r=W.requestedTransition(t);if(null!=r){var a=(o=r,(i=H)in(n=O)?n[i]:(console.error("No transition from",i,"with transition",o),null));null!=a&&x(a)}K.renderer.render(K.stage)}var D=function(o){function r(){return e(this,r),i(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return n(r,p),t(r,[{key:"setup",value:function(){document.getElementById("intro-gui").style.display="block",document.getElementById("user-provided-id").addEventListener("keyup",this.onSetUserProvidedId.bind(this)),this.done=!1,document.getElementById("done-intro").disabled=!0,document.getElementById("done-intro").addEventListener("click",this.onDone.bind(this))}},{key:"teardown",value:function(){document.getElementById("intro-gui").style.display="none"}},{key:"requestedTransition",value:function(e){return this.done?"next":null}},{key:"onSetUserProvidedId",value:function(e){document.getElementById("done-intro").disabled=0===document.getElementById("user-provided-id").value.length,13!==e.keyCode||document.getElementById("done-intro").disabled||this.onDone()}},{key:"onDone",value:function(){Q.customData.userProvidedId=document.getElementById("user-provided-id").value,j.updatePlayer(Q),this.done=!0}}]),r}(),M=function(o){function r(){return e(this,r),i(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return n(r,p),t(r,[{key:"setup",value:function(){var e=this;this.done=!1,this.didDropBlock=!1,this.blockScene=new X(!0),this.blockScene.setup(),this.blockScene.preventAddingShape=!0,document.getElementById("add-shape").style.display="none",document.getElementById("done-adding").style.display="none",this.blockScene.on("droppedBlock",this.onDroppedBlock,this),this.blockScene.on("addedShape",this.onAddedShape,this),document.getElementById("training-gui").style.display="block",document.getElementById("done-training-1").addEventListener("click",this.onDonePart1.bind(this)),document.getElementById("done-training-2").addEventListener("click",this.onDonePart2.bind(this)),document.getElementById("done-training-4").addEventListener("click",function(t){return e.done=!0})}},{key:"update",value:function(e){this.blockScene.update(e)}},{key:"teardown",value:function(){this.blockScene.off("droppedBlock",this.onDroppedBlock,this),this.blockScene.off("addedShape",this.onAddedShape,this),this.blockScene.teardown(),document.getElementById("done-adding").style.display="block",document.getElementById("training-gui").style.display="none"}},{key:"requestedTransition",value:function(e){return this.done?"next":null}},{key:"onDroppedBlock",value:function(){this.didDropBlock||(this.didDropBlock=!0,this.blockScene.highlightMovableBlocks(),document.getElementById("done-training-1").style.display="block")}},{key:"onDonePart1",value:function(){document.getElementById("training-1").style.display="none",document.getElementById("training-2").style.display="block"}},{key:"onDonePart2",value:function(){this.blockScene.unhighlightMovableBlocks(),document.getElementById("training-2").style.display="none",document.getElementById("training-3").style.display="block",document.getElementById("add-shape").style.display="block",this.blockScene.preventAddingShape=!1}},{key:"onAddedShape",value:function(){document.getElementById("training-3").style.display="none",document.getElementById("training-4").style.display="block"}}]),r}(),X=function(o){function a(){return e(this,a),i(this,(a.__proto__||Object.getPrototypeOf(a)).apply(this,arguments))}return n(a,p),t(a,[{key:"setup",value:function(){this.done=!1,this.draggingBlock=null,this.draggingBlockStartGridPosition=null,this.startDragTime=null,this.highlightedBlocks=new Set,this.targetBlockContainerPosition=new PIXI.Point,this.lastMouseUpTime=0,this.draggingPointerId=null,this.preventAddingShape=!1,this.timesUp=!1,this.changedShape=!0,this.container=new PIXI.Container,J.addChild(this.container);var e=new PIXI.Graphics;e.beginFill(8421504),e.lineColor=16777215,e.lineWidth=1,e.drawRect(0,0,150,150),e.endFill(),e.position.set(800,10),e.on("pointerdown",this.onAddShape,this),e.interactive=!0,this.container.addChild(e),this.blocksContainer=new PIXI.Container,this.container.addChild(this.blocksContainer),this.blockGrid=[];for(var t=0;t<10;t++){var n=new PIXI.Point(t,0);this.blockGrid.push(n);var i=b(n);i.buttonMode=!0,i.on("pointerdown",this.onPointerDown.bind(this)),i.on("pointerup",this.onPointerUp.bind(this)),i.on("pointermove",this.onPointerMove.bind(this)),this.blocksContainer.addChild(i)}this.updateBlocks();var o=new PIXI.Container;o.position.set(875,85),o.scale.set(.3),this.container.addChild(o),this.galleryLayer=new PIXI.Container,o.addChild(this.galleryLayer),document.getElementById("blocks-gui").style.display="block",this.onAddShape=this.onAddShape.bind(this),this.onAttemptDone=this.onAttemptDone.bind(this),this.cancelModal=this.cancelModal.bind(this),this.confirmDone=this.confirmDone.bind(this),document.getElementById("add-shape").addEventListener("click",this.onAddShape),document.getElementById("modal-confirm-cancel-button").addEventListener("click",this.cancelModal),document.getElementById("modal-confirm-done-button").addEventListener("click",this.confirmDone);var r=document.getElementById("done-adding");r.addEventListener("click",this.onAttemptDone),r.disabled=!R}},{key:"update",value:function(e){if(!this.timesUp){e>72e4&&(this.timesUp=!0,document.getElementById("add-shape").disabled=!0,G.length<5?(document.getElementById("stuck-message").style.display="block",document.getElementById("done-adding").disabled=!0):(document.getElementById("continue-message").style.display="block",document.getElementById("done-adding").disabled=!1));var t,n,i,o,r,a,l,s,d,c,u,y,g=!0,p=!1,f=void 0;try{for(var v,k=this.highlightedBlocks[Symbol.iterator]();!(g=(v=k.next()).done);g=!0){I(v.value,(t=m,n=5866811,(i=e%500/500)<.5?h(t,n,i/.5):h(n,t,(i-.5)/.5)))}}catch(e){p=!0,f=e}finally{try{!g&&k.return&&k.return()}finally{if(p)throw f}}d=this.targetBlockContainerPosition,c=this.blocksContainer.position,u=d.x-c.x,y=d.y-c.y,Math.sqrt(u*u+y*y)>1&&(this.blocksContainer.position=(o=this.blocksContainer.position,r=this.targetBlockContainerPosition,a=.5,l=r.x-o.x,s=r.y-o.y,new PIXI.Point(o.x+a*l,o.y+a*s)))}}},{key:"teardown",value:function(){J.removeChild(this.container),document.getElementById("blocks-gui").style.display="none",document.getElementById("add-shape").removeEventListener("click",this.onAddShape),document.getElementById("done-adding").removeEventListener("click",this.onAttemptDone),document.getElementById("modal-confirm-cancel-button").removeEventListener("click",this.cancelModal),document.getElementById("modal-confirm-done-button").removeEventListener("click",this.confirmDone)}},{key:"requestedTransition",value:function(e){return this.done?"next":null}},{key:"highlightMovableBlocks",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this.blocksContainer.children[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value;this.canMoveBlock(k(r.position))&&this.highlightedBlocks.add(r)}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"unhighlightMovableBlocks",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this.blocksContainer.children[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value;this.canMoveBlock(k(r.position))&&this.unhighlightBlock(r)}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"unhighlightBlock",value:function(e){this.highlightedBlocks.delete(e),I(e,m)}},{key:"onPointerDown",value:function(e){if(!this.draggingBlock&&!this.timesUp){this.draggingBlock=e.currentTarget,this.draggingPointerId=e.data.pointerId,this.draggingBlockStartGridPosition=k(this.draggingBlock.position),this.startDragTime=Date.now(),this.blocksContainer.setChildIndex(this.draggingBlock,this.blocksContainer.children.length-1);var t=k(this.draggingBlock.position);this.blockGrid=u(this.blockGrid,t),this.highlightedBlocks.add(this.draggingBlock),document.getElementById("html-layer").className="no-pointer-events"}}},{key:"onPointerUp",value:function(e){this.draggingBlock&&(this.dropBlock(this.draggingBlock,this.draggingBlock.position),this.unhighlightBlock(this.draggingBlock),this.draggingBlock=null,this.draggingPointerId=null,this.updateBlocks(),document.getElementById("add-shape").disabled=!1,this.changedShape=!0,document.getElementById("html-layer").className="",this.emit("droppedBlock"))}},{key:"onPointerMove",value:function(e){this.draggingBlock&&e.data.pointerId===this.draggingPointerId&&(this.draggingBlock.position=r(e.data.getLocalPosition(K.stage),this.blocksContainer.position))}},{key:"updateBlocks",value:function(){this.updateTargetBlockContainerPosition(),this.updateBlockInteractivity()}},{key:"updateTargetBlockContainerPosition",value:function(){var e=new PIXI.Point(K.view.width/2,K.view.height/2),t=this.blocksContainer.children.map(function(e){return e.position}),n=d(l.apply(null,t),s.apply(null,t));this.targetBlockContainerPosition=r(e,n)}},{key:"updateBlockInteractivity",value:function(){var e=!0,t=!1,n=void 0;try{for(var i,o=this.blocksContainer.children[Symbol.iterator]();!(e=(i=o.next()).done);e=!0){var r=i.value;this.canMoveBlock(k(r.position))?r.interactive=!0:r.interactive=!1}}catch(e){t=!0,n=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw n}}}},{key:"dropBlock",value:function(e,t){var n=k(t),i=this.findFreeGridPositions(),o=_.min(i,function(e){return i=e,o=(t=n).x-i.x,r=t.y-i.y,Math.sqrt(o*o+r*r);var t,i,o,r});e.position=v(o),this.blockGrid.push(o),this.lastMouseUpTime=Date.now(),j.postEvent({type:"movedBlock",customData:{startPosition:B(this.draggingBlockStartGridPosition),endPosition:B(o),time:Date.now()-this.startDragTime,newShape:w(this.blockGrid)}})}},{key:"findFreeGridPositions",value:function(){var e,t,n,i=[],o=!0,r=!1,a=void 0;try{for(var l,s=this.blockGrid[Symbol.iterator]();!(o=(l=s.next()).done);o=!0){var d=l.value;i.push(new PIXI.Point(d.x-1,d.y)),i.push(new PIXI.Point(d.x+1,d.y)),i.push(new PIXI.Point(d.x,d.y-1)),i.push(new PIXI.Point(d.x,d.y+1))}}catch(e){r=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(r)throw a}}return t=[],n=[],(e=i).forEach(function(i,o){c(n,i)||(n.push(i),t.push(e[o]))}),function(e){var t=Array.prototype.concat.apply(Array.prototype,Array.prototype.slice.call(arguments,1));return _.filter(e,function(e){return!c(t,e)})}(i=t,this.blockGrid)}},{key:"blocksAreNeighbors",value:function(e,t){var n=Math.abs(e.x-t.x),i=Math.abs(e.y-t.y);return 1==n&&0==i||0==n&&1==i}},{key:"makeAdjacencyList",value:function(e){for(var t=_.map(e,function(){return[]}),n=0;n<e.length-1;n++)for(var i=n+1;i<e.length;i++)this.blocksAreNeighbors(e[n],e[i])&&(t[n].push(i),t[i].push(n));return t}},{key:"visitBlocks",value:function(e,t){for(var n=[t];;){var i=_.reduce(n[n.length-1],function(t,n){return t.concat(e[n])},[]);if(i=_.uniq(i),!((i=_.difference.apply(_,[i].concat(n))).length>0))return n;n.push(i)}}},{key:"canMoveBlock",value:function(e){var t=u(this.blockGrid,e),n=this.makeAdjacencyList(t),i=this.visitBlocks(n,[0]);return _.flatten(i).length==t.length}},{key:"onAddShape",value:function(){if(!this.preventAddingShape&&!this.timesUp&&this.changedShape){var e,t=(e=this.blockGrid,JSON.parse(JSON.stringify(e)));G.push(t),this.updateGalleryShape(t),document.getElementById("end-early-message").style.display="none",document.getElementById("add-shape").disabled=!0,this.changedShape=!1,j.postEvent({type:"added shape to gallery",customData:{shape:w(this.blockGrid),timeSinceLastMouseUp:Date.now()-this.lastMouseUpTime}}),this.emit("addedShape")}}},{key:"onAttemptDone",value:function(){this.timesUp||!R?this.confirmDone():G.length<5?document.getElementById("end-early-message").style.display="block":document.getElementById("modal-confirm-done").style.display="block"}},{key:"cancelModal",value:function(){document.getElementById("modal-confirm-done").style.display="none"}},{key:"confirmDone",value:function(){this.done=!0,N=E()}},{key:"updateGalleryShape",value:function(e){this.galleryLayer.removeChildren();var t=!0,n=!1,i=void 0;try{for(var o,r=e[Symbol.iterator]();!(t=(o=r.next()).done);t=!0){var a=o.value;this.galleryLayer.addChild(b(a))}}catch(e){n=!0,i=e}finally{try{!t&&r.return&&r.return()}finally{if(n)throw i}}g(this.galleryLayer,new PIXI.Point)}}]),a}(),F=function(o){function r(){return e(this,r),i(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return n(r,p),t(r,[{key:"setup",value:function(){var e=this;this.done=!1,this.selectedIndexes=[],this.pageNumber=0,this.container=new PIXI.Container,J.addChild(this.container),this.pages=new PIXI.Container,this.container.addChild(this.pages);for(var t=void 0,n=function(n){var i=Math.floor(n%50/10),o=Math.floor(n%50%10);n%50==0&&((t=new PIXI.Container).visible=!1,e.pages.addChild(t));var r=new PIXI.Point(70+90*o,95+85*i),a=new PIXI.Graphics;a.beginFill(3355443),a.drawRect(-40,-40,80,80),a.endFill(),a.position=r,t.addChild(a),a.on("pointerdown",function(t){return e.onToggleShape(a,n)}),a.buttonMode=!0,a.interactive=!0;var l=new PIXI.Container;l.position=r,l.scale.set(.1),t.addChild(l);var s=new PIXI.Container,d=!0,c=!1,u=void 0;try{for(var h,y=G[n][Symbol.iterator]();!(d=(h=y.next()).done);d=!0){var p=h.value;s.addChild(b(p))}}catch(e){c=!0,u=e}finally{try{!d&&y.return&&y.return()}finally{if(c)throw u}}g(s,new PIXI.Point),l.addChild(s)},i=0;i<G.length;i++)n(i);document.getElementById("selection-gui").style.display="block",document.getElementById("done-selection").addEventListener("click",function(t){return e.done=!0}),document.getElementById("previous-page-button").addEventListener("click",function(t){return e.changePage(e.pageNumber-1)}),document.getElementById("next-page-button").addEventListener("click",function(t){return e.changePage(e.pageNumber+1)}),this.updateDoneButton(),this.changePage(0)}},{key:"update",value:function(e){this.done&&(N=E(G.length,e))}},{key:"teardown",value:function(){J.removeChild(this.container),document.getElementById("selection-gui").style.display="none"}},{key:"requestedTransition",value:function(e){return this.done?"next":null}},{key:"onToggleShape",value:function(e,t){var n=!_.contains(this.selectedIndexes,t);n?this.selectedIndexes.push(t):this.selectedIndexes=u(this.selectedIndexes,t),e.beginFill(n?10167590:3355443),e.drawRect(-40,-40,80,80),e.endFill(),this.updateDoneButton(),j.postEvent({type:"selected shape",customData:{shapeIndex:t,shape:w(G[t]),isSelected:n}})}},{key:"updateDoneButton",value:function(){document.getElementById("done-selection").disabled=5!=this.selectedIndexes.length}},{key:"changePage",value:function(e){this.pages.children[this.pageNumber].visible=!1,this.pageNumber=e,this.pages.children[this.pageNumber].visible=!0,document.getElementById("previous-page-button").disabled=0==this.pageNumber,document.getElementById("next-page-button").disabled=this.pageNumber==this.pages.children.length-1}}]),r}(),L=function(o){function r(){return e(this,r),i(this,(r.__proto__||Object.getPrototypeOf(r)).apply(this,arguments))}return n(r,p),t(r,[{key:"setup",value:function(){if(this.container=new PIXI.Container,J.addChild(this.container),document.getElementById("results-gui").style.display="block",U){document.getElementById("thanks-block").style.display="none";var e=new PIXI.Sprite(K.loader.resources["images/slider.png"].texture);e.anchor.set(.5),e.position.set(K.renderer.width/2,145),this.container.addChild(e);var t=new PIXI.Graphics;t.beginFill(2934316),t.drawCircle(K.renderer.width/2+255*N,120,10),this.container.addChild(t),N>0?document.getElementById("rapid-search-text").style.display="block":document.getElementById("focused-search-text").style.display="block";var n=Math.round(100*Math.abs(N)),i=!0,o=!1,r=void 0;try{for(var a,l=document.getElementsByClassName("searchScorePercent")[Symbol.iterator]();!(i=(a=l.next()).done);i=!0){a.value.innerText=n}}catch(e){o=!0,r=e}finally{try{!i&&l.return&&l.return()}finally{if(o)throw r}}if(document.getElementById("code").innerText=j.playerId?j.playerId.substr(-8):"Unknown",q.has("followupLink")){var s=q.get("expId")||q.get("expID")||"",d=q.get("userId")||q.get("userID")||"",c=j.playerId||"",u=Q.customData.userProvidedId||"",h=q.get("followupLink");_.contains(h,"?")||(h+="?"),h+="&IDExp="+s+"&IDUser="+d+"&IDMetrics="+c+"&IDUserProvided="+u,document.getElementById("followup-link").href=h}else document.getElementById("followup-link-container").style.display="none"}else document.getElementById("results-block").style.display="none"}},{key:"teardown",value:function(){document.getElementById("results-gui").style.display="none",J.removeChild(this.container)}}]),r}(),A={intro:D,training:M,block:X,gallery:F,results:L},O={intro:"training",training:"block",block:"gallery",gallery:"results"},T={intro:"startIntro",training:"startTutorial",block:"startSearch",gallery:"end search",results:"startFeedback"},q=new URLSearchParams(window.location.search),R="false"!==q.get("allowEarlyExit")&&"0"!==q.get("allowEarlyExit"),U="false"!==q.get("showResults")&&"0"!==q.get("showResults"),G=[],N=.33,j=void 0,z="intro",J=void 0,W=void 0,H=void 0,V=0,K=new PIXI.Application({width:960,height:540,view:document.getElementById("pixi-canvas"),antialias:!0});K.loader.add(["images/slider.png"]).on("progress",function(e,t){console.log("loading: "+t.url),console.log("progress: "+e.progress+"%")}).load(function(){var e,t;J=new PIXI.Container,K.stage.addChild(J),K.ticker.add(C),j.postEvent({type:"start"}),(e=document.getElementById("game-parent")).requestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen||e.msRequestFullscreen?(document.getElementById("fullscreen-button").addEventListener("click",P),S(!0)):document.getElementById("fullscreen-button").style.display="none",x((t=z,new URLSearchParams(window.location.search).get("scene")||t))});var Q={externalId:q.get("userId")||q.get("userID"),customData:{expId:q.get("expId")||q.get("expID"),userId:q.get("userId")||q.get("userID"),userAgent:navigator.userAgent}};(j=redmetrics.prepareWriteConnection({gameVersionId:"0b0986f3-9119-4d90-82fb-20ee4842da69",player:Q})).connect().then(function(){console.log("Connected to the RedMetrics server")}),y(K),window.addEventListener("resize",function(){return y(K)})});